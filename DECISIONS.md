# Архитектурные решения

Документ для фиксации ключевых решений проекта.
Помогает не забыть "почему так сделали" и не повторять ошибки.

---

## 2025-01-15: Выбор языка — Python

**Решение:** Использовать Python

**Причины:**
- MCP SDK официально поддерживает только Python и TypeScript
- Лучшие библиотеки для GUI-автоматизации Windows (pywinauto, pyautogui)
- EasyOCR работает на Python
- Быстрое прототипирование

**Альтернативы которые отвергли:**
- C# — нет MCP SDK
- TypeScript — слабые GUI-библиотеки для Windows
- AutoHotkey — примитивный язык

---

## 2025-01-15: OCR — EasyOCR вместо Tesseract

**Решение:** EasyOCR как основной движок

**Причины:**
- Лучше распознаёт цифры и цены
- Не требует установки отдельных бинарников
- GPU-ускорение из коробки

**Компромисс:** Tesseract как fallback (если EasyOCR не установлен)

---

## 2025-01-15: Гибридный подход к автоматизации

**Решение:** Комбинировать несколько методов поиска элементов

**Стратегии (по приоритету):**
1. UI Automation — быстро, надёжно для Java Swing элементов
2. Hotkeys TWS — самый надёжный способ для действий
3. OCR — для кастомных элементов
4. Координаты — последний резерв

**Причина:** Java Swing имеет хорошую поддержку accessibility, но OCR нужен для некоторых элементов

---

## 2025-01-15: Safety by default

**Решение:** Paper trading по умолчанию, защита от случайных ордеров

**Реализация:**
- Проверка `tradingMode=p` в jts.ini перед стартом
- `max_order_quantity = 1000` по умолчанию
- `confirm_orders = True` по умолчанию
- PyAutoGUI failsafe (курсор в угол = стоп)

**Причина:** Это реальные деньги, ошибка может стоить дорого

---

## 2025-01-15: Структура проекта — модульная

**Решение:** Разделить на независимые модули

```
core/    — базовые примитивы (window, element)
input/   — ввод (keyboard, mouse, hotkeys)
screen/  — вывод (capture, ocr)
actions/ — высокоуровневые действия
```

**Причина:**
- Легко тестировать по отдельности
- Легко заменять компоненты
- Понятно где что искать

---

## 2026-01-16: Переход с IBKR Desktop на TWS

**Решение:** Переориентировать проект с IBKR Desktop (Qt/QML) на TWS (Java Swing)

**Причины:**
- TWS — более функциональный терминал
- Java Swing лучше поддерживает UI Automation чем Qt/QML
- Пользователю нужен именно TWS

**Изменения:**
- Переименование ntws_automation → tws_automation
- Обновление паттерна поиска окна для TWS
- Путь по умолчанию: C:\Jts (вместо C:\ntws)
- Процесс: tws.exe (вместо ntws.exe)

---

## 2026-01-19: Hotkeys через Win32 SendInput

**Решение:** Использовать Win32 SendInput API напрямую для отправки хоткеев вместо pyautogui/pywinauto

**Проблема:**
- `pyautogui.hotkey()` — не работает с Java Swing (TWS игнорирует)
- `pywinauto.send_keys()` — сообщения не доходят до Java-приложений
- `keyboard.send()` — конфликтует с Java

**Причины выбора SendInput:**
- Вставляет события клавиатуры напрямую в системную очередь ввода
- Эмулирует реальное физическое нажатие клавиши
- Java Swing видит это как настоящий ввод пользователя
- Работает с любым приложением

**Реализация:**
```python
def _send_input_key(vk: int, key_up: bool = False):
    inp = INPUT()
    inp.type = INPUT_KEYBOARD
    inp.ki.wVk = vk
    inp.ki.dwFlags = KEYEVENTF_KEYUP if key_up else 0
    user32.SendInput(1, ctypes.byref(inp), ctypes.sizeof(INPUT))
```

**Ограничения:**
- Требует фокус на целевом окне
- Глобальный — клавиши идут в активное окно
- Только Windows
- Больше boilerplate кода (структуры Win32)

**Тестирование:**
- Проверено на TWS Chart Trader
- Ctrl+Shift+B (BUY) и Ctrl+Shift+S (SELL) работают стабильно

---

## Шаблон для новых решений

```markdown
## ДАТА: Название решения

**Решение:** Что решили

**Причины:**
- Почему так

**Альтернативы которые отвергли:**
- Что не подошло и почему

**Компромиссы:**
- Чем пожертвовали
```
